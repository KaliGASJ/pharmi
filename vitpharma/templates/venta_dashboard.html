{% extends 'base.html' %}

{% block title %}Registrar Venta | VIT PHARMA{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Título principal -->
    <h2 class="text-center mb-4">🧾 Registrar Nueva Venta</h2>

    <!-- Mensaje de error o confirmación -->
    {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
                <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-warning{% endif %} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Información sobre efectivo en caja -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-cash-register me-2"></i>Información de Caja</h5>
            <span class="badge bg-light text-dark" id="fecha-hora-actual"></span>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Turno activo #:</strong> <span class="badge bg-success">{{ turno_activo.id }}</span></p>
                    <p><strong>Vendedor:</strong> {{ request.user.get_full_name|default:request.user.username }}</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p><strong>Efectivo disponible en caja:</strong> <span class="badge bg-primary fs-5" id="efectivo-caja">${{ efectivo_en_caja|floatformat:2 }}</span></p>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="btnActualizarCaja">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                    <a href="{% url 'ventas:historial_ventas' %}" class="btn btn-sm btn-outline-secondary ms-2">
                        <i class="fas fa-history"></i> Historial
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Columna izquierda: Búsqueda de productos -->
        <div class="col-lg-5 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-search me-2"></i>Buscar Productos</h5>
                </div>
                <div class="card-body">
                    <!-- Buscador de productos -->
                    <form id="searchForm" class="mb-3">
                        <div class="input-group">
                            <input type="text" id="buscar-producto" class="form-control" 
                                placeholder="Buscar por nombre o código de barras" 
                                value="{{ busqueda_form.busqueda.value|default:'' }}">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>

                    <!-- Resultados de búsqueda -->
                    <div id="resultados-busqueda" class="list-group" style="max-height: 300px; overflow-y: auto;">
                        {% if productos %}
                            {% for producto in productos %}
                                <button type="button" class="list-group-item list-group-item-action producto-item" 
                                        data-id="{{ producto.id_producto }}" data-nombre="{{ producto.nombre }}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ producto.nombre }}</strong>
                                            <small class="d-block text-muted">CB: {{ producto.codigo_barras }}</small>
                                        </div>
                                        <span class="badge bg-primary rounded-pill">{{ producto.total_stock }}</span>
                                    </div>
                                </button>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-3 text-muted">
                                <i class="fas fa-search fa-2x mb-2"></i>
                                <p>Busca productos por nombre o código de barras</p>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Selector de lote -->
                    <div id="selector-lote" class="mt-3 d-none">
                        <h6 class="mb-2">Seleccionar Lote:</h6>
                        <select id="lotes-disponibles" class="form-select mb-2">
                            <option value="">Seleccione un lote</option>
                        </select>
                        
                        <div class="row mb-2 d-none" id="lote-info">
                            <div class="col-6">
                                <small class="text-muted d-block">Precio:</small>
                                <span id="lote-precio" class="fw-bold"></span>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Disponible:</small>
                                <span id="lote-stock" class="fw-bold"></span>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Descuento:</small>
                                <span id="lote-descuento" class="fw-bold"></span>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Caducidad:</small>
                                <span id="lote-caducidad" class="fw-bold"></span>
                            </div>
                        </div>
                        
                        <div class="row align-items-end">
                            <div class="col-5">
                                <label for="cantidad-producto" class="form-label">Cantidad:</label>
                                <input type="number" id="cantidad-producto" class="form-control" min="1" value="1">
                            </div>
                            <div class="col-7 d-grid">
                                <button type="button" id="agregar-carrito" class="btn btn-success">
                                    <i class="fas fa-cart-plus"></i> Agregar al Carrito
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna derecha: Carrito y finalización de venta -->
        <div class="col-lg-7">
            <form method="post" id="form-venta">
                {% csrf_token %}
                <!-- Campos ocultos para enviar carrito -->
                {{ form_venta.carrito_json }}
                
                <!-- Carrito de compras -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Carrito de Compras</h5>
                        <button type="button" id="vaciar-carrito" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-trash-alt"></i> Vaciar
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0" id="tabla-carrito">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Producto</th>
                                        <th>Lote</th>
                                        <th>Cantidad</th>
                                        <th>Precio</th>
                                        <th>Subtotal</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="items-carrito">
                                    <!-- Aquí se insertan los items del carrito dinámicamente -->
                                    <tr id="carrito-vacio">
                                        <td colspan="6" class="text-center py-3 text-muted">
                                            <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                                            <p>El carrito está vacío</p>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot class="table-primary">
                                    <tr>
                                        <th colspan="4" class="text-end">Total:</th>
                                        <th id="total-carrito" class="text-end">$0.00</th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Detalles de pago -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Detalles de Pago</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form_venta.metodo_pago.id_for_label }}" class="form-label fw-bold">
                                    {{ form_venta.metodo_pago.label }}:
                                </label>
                                {{ form_venta.metodo_pago }}
                                {% if form_venta.metodo_pago.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form_venta.metodo_pago.errors|striptags }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3" id="div-cuanto-paga">
                                <label for="{{ form_venta.con_cuanto_paga.id_for_label }}" class="form-label fw-bold">
                                    {{ form_venta.con_cuanto_paga.label }}:
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form_venta.con_cuanto_paga }}
                                </div>
                                {% if form_venta.con_cuanto_paga.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form_venta.con_cuanto_paga.errors|striptags }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row" id="div-cambio-calculado">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form_venta.total_venta.id_for_label }}" class="form-label fw-bold">
                                    {{ form_venta.total_venta.label }}:
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form_venta.total_venta }}
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form_venta.cambio_calculado.id_for_label }}" class="form-label fw-bold">
                                    {{ form_venta.cambio_calculado.label }}:
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form_venta.cambio_calculado }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de acción -->
                <div class="d-flex justify-content-between">
                    <a href="{% url 'authapp:vendedor_dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Regresar al panel
                    </a>
                    
                    <div>
                        <a href="{% url 'ventas:cancelar_venta' %}" class="btn btn-danger me-2">
                            <i class="fas fa-times-circle me-2"></i>Cancelar venta
                        </a>
                        <button type="submit" id="btn-registrar-venta" class="btn btn-success">
                            <i class="fas fa-check-circle me-2"></i>Registrar venta
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Script para la funcionalidad del carrito -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variables globales
    let carrito = [];
    const carritoJson = document.getElementById('{{ form_venta.carrito_json.id_for_label }}');
    const totalCarrito = document.getElementById('total-carrito');
    const itemsCarrito = document.getElementById('items-carrito');
    const carritoVacio = document.getElementById('carrito-vacio');
    const btnRegistrarVenta = document.getElementById('btn-registrar-venta');
    const totalVentaInput = document.getElementById('{{ form_venta.total_venta.id_for_label }}');
    const metodoPagoSelect = document.getElementById('{{ form_venta.metodo_pago.id_for_label }}');
    const conCuantoPagaInput = document.getElementById('{{ form_venta.con_cuanto_paga.id_for_label }}');
    const cambioCalculadoInput = document.getElementById('{{ form_venta.cambio_calculado.id_for_label }}');
    const divCuantoPaga = document.getElementById('div-cuanto-paga');
    
    // Inicializar carrito vacío
    actualizarCarrito();
    
    // Evento: Búsqueda de productos
    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const busqueda = document.getElementById('buscar-producto').value.trim();
        if (!busqueda) return;
        
        // En producción, habría que hacer una solicitud AJAX para obtener los productos
        // Para este ejemplo, consideramos que los productos ya están disponibles
    });
    
    // Evento: Seleccionar producto de la lista de resultados
    document.querySelectorAll('.producto-item').forEach(item => {
        item.addEventListener('click', function() {
            const productoId = this.getAttribute('data-id');
            const productoNombre = this.getAttribute('data-nombre');
            
            // Ocultar resultados y mostrar selector de lote
            document.getElementById('selector-lote').classList.remove('d-none');
            
            // Cargar lotes disponibles mediante AJAX
            fetch(`/ventas/get-lotes-producto/?producto_id=${productoId}`)
                .then(response => response.json())
                .then(data => {
                    const lotesSelect = document.getElementById('lotes-disponibles');
                    lotesSelect.innerHTML = '<option value="">Seleccione un lote</option>';
                    
                    if (data.lotes && data.lotes.length > 0) {
                        data.lotes.forEach(lote => {
                            lotesSelect.innerHTML += `<option value="${lote.id}" 
                                data-precio="${lote.precio_venta}"
                                data-descuento="${lote.descuento_porcentaje}"
                                data-stock="${lote.cantidad}"
                                data-caducidad="${lote.fecha_caducidad}">${lote.lote} (${lote.codigo})</option>`;
                        });
                    } else {
                        lotesSelect.innerHTML += '<option value="" disabled>No hay lotes disponibles</option>';
                    }
                })
                .catch(error => console.error('Error al cargar lotes:', error));
        });
    });
    
    // Evento: Seleccionar lote
    document.getElementById('lotes-disponibles').addEventListener('change', function() {
        const loteInfo = document.getElementById('lote-info');
        
        if (this.value) {
            // Mostrar información del lote seleccionado
            const selectedOption = this.options[this.selectedIndex];
            const precio = parseFloat(selectedOption.getAttribute('data-precio'));
            const descuento = parseFloat(selectedOption.getAttribute('data-descuento'));
            const stock = parseInt(selectedOption.getAttribute('data-stock'));
            const caducidad = selectedOption.getAttribute('data-caducidad');
            
            // Actualizar información visible
            document.getElementById('lote-precio').textContent = `${precio.toFixed(2)}`;
            document.getElementById('lote-descuento').textContent = `${descuento}%`;
            document.getElementById('lote-stock').textContent = `${stock} unidades`;
            document.getElementById('lote-caducidad').textContent = caducidad;
            
            // Limitar cantidad máxima según stock disponible
            document.getElementById('cantidad-producto').max = stock;
            
            // Mostrar información del lote
            loteInfo.classList.remove('d-none');
        } else {
            loteInfo.classList.add('d-none');
        }
    });
    
    // Evento: Agregar al carrito
    document.getElementById('agregar-carrito').addEventListener('click', function() {
        const lotesSelect = document.getElementById('lotes-disponibles');
        const selectedOption = lotesSelect.options[lotesSelect.selectedIndex];
        
        if (!lotesSelect.value) {
            alert('Debe seleccionar un lote para agregar al carrito');
            return;
        }
        
        const cantidadInput = document.getElementById('cantidad-producto');
        const cantidad = parseInt(cantidadInput.value);
        
        if (isNaN(cantidad) || cantidad < 1) {
            alert('La cantidad debe ser mayor a cero');
            return;
        }
        
        const stock = parseInt(selectedOption.getAttribute('data-stock'));
        if (cantidad > stock) {
            alert(`Solo hay ${stock} unidades disponibles en este lote`);
            return;
        }
        
        // Preparar datos del producto
        const productoId = document.querySelector('.producto-item[data-id]').getAttribute('data-id');
        const productoNombre = document.querySelector('.producto-item[data-id]').getAttribute('data-nombre');
        const loteId = lotesSelect.value;
        const loteCodigo = selectedOption.text;
        const precio = parseFloat(selectedOption.getAttribute('data-precio'));
        const descuentoPorcentaje = parseFloat(selectedOption.getAttribute('data-descuento'));
        
        // Calcular precios
        const descuentoUnitario = (precio * descuentoPorcentaje / 100);
        const precioConDescuento = precio - descuentoUnitario;
        const subtotal = precioConDescuento * cantidad;
        
        // Verificar si ya existe en el carrito para actualizar cantidad
        const itemExistente = carrito.findIndex(item => item.lote_id === loteId);
        
        if (itemExistente >= 0) {
            // Actualizar cantidad del item existente
            const nuevaCantidad = carrito[itemExistente].cantidad + cantidad;
            if (nuevaCantidad > stock) {
                alert(`No puede agregar más de ${stock} unidades en total`);
                return;
            }
            carrito[itemExistente].cantidad = nuevaCantidad;
            carrito[itemExistente].subtotal = precioConDescuento * nuevaCantidad;
        } else {
            // Agregar nuevo item al carrito
            carrito.push({
                producto_id: productoId,
                producto_nombre: productoNombre,
                lote_id: loteId,
                lote_codigo: loteCodigo,
                cantidad: cantidad,
                precio_unitario: precio,
                descuento_porcentaje: descuentoPorcentaje,
                descuento_aplicado: descuentoUnitario,
                subtotal: subtotal
            });
        }
        
        // Actualizar carrito y limpiar selección
        actualizarCarrito();
        cantidadInput.value = 1;
        lotesSelect.selectedIndex = 0;
        document.getElementById('lote-info').classList.add('d-none');
        
        // Notificar al usuario
        const mensaje = document.createElement('div');
        mensaje.className = 'alert alert-success alert-dismissible fade show position-fixed bottom-0 end-0 m-3';
        mensaje.innerHTML = `
            <i class="fas fa-check-circle me-2"></i> Producto agregado al carrito
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.appendChild(mensaje);
        setTimeout(() => mensaje.remove(), 3000);
    });
    
    // Evento: Vaciar carrito
    document.getElementById('vaciar-carrito').addEventListener('click', function() {
        if (carrito.length === 0) return;
        
        if (confirm('¿Está seguro de vaciar el carrito?')) {
            carrito = [];
            actualizarCarrito();
        }
    });
    
    // Evento: Cambio en método de pago
    metodoPagoSelect.addEventListener('change', function() {
        const esEfectivo = this.options[this.selectedIndex].text.toLowerCase().includes('efectivo');
        
        // Mostrar/ocultar campos relacionados con efectivo
        if (esEfectivo) {
            divCuantoPaga.classList.remove('d-none');
        } else {
            divCuantoPaga.classList.add('d-none');
            conCuantoPagaInput.value = '';
            cambioCalculadoInput.value = '';
        }
    });
    
    // Evento: Calcular cambio al ingresar con cuánto paga
    conCuantoPagaInput.addEventListener('input', function() {
        const conCuantoPaga = parseFloat(this.value);
        const total = calcularTotalCarrito();
        
        if (!isNaN(conCuantoPaga) && conCuantoPaga >= total) {
            const cambio = conCuantoPaga - total;
            cambioCalculadoInput.value = cambio.toFixed(2);
        } else {
            cambioCalculadoInput.value = '0.00';
        }
    });
    
    // Evento: Enviar formulario
    document.getElementById('form-venta').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (carrito.length === 0) {
            alert('No hay productos en el carrito');
            return;
        }
        
        const metodoPago = metodoPagoSelect.options[metodoPagoSelect.selectedIndex];
        if (!metodoPago || metodoPago.value === '') {
            alert('Debe seleccionar un método de pago');
            return;
        }
        
        const esEfectivo = metodoPago.text.toLowerCase().includes('efectivo');
        if (esEfectivo) {
            const conCuantoPaga = parseFloat(conCuantoPagaInput.value);
            const total = calcularTotalCarrito();
            
            if (isNaN(conCuantoPaga) || conCuantoPaga < total) {
                alert('El monto entregado debe ser mayor o igual al total de la venta');
                return;
            }
        }
        
        // Guardar carrito en el campo oculto para enviar al servidor
        carritoJson.value = JSON.stringify(carrito);
        totalVentaInput.value = calcularTotalCarrito().toFixed(2);
        
        // Enviar formulario
        this.submit();
    });
    
    // Función: Actualizar visualización del carrito
    function actualizarCarrito() {
        if (carrito.length === 0) {
            carritoVacio.style.display = 'table-row';
            totalCarrito.textContent = '$0.00';
            carritoJson.value = '[]';
            btnRegistrarVenta.disabled = true;
        } else {
            carritoVacio.style.display = 'none';
            
            // Limpiar tabla
            const filas = itemsCarrito.querySelectorAll('tr:not(#carrito-vacio)');
            filas.forEach(fila => fila.remove());
            
            // Agregar productos al carrito
            carrito.forEach((item, index) => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>
                        <strong>${item.producto_nombre}</strong>
                    </td>
                    <td>${item.lote_codigo}</td>
                    <td>
                        <div class="input-group input-group-sm">
                            <button type="button" class="btn btn-outline-secondary btn-restar" data-index="${index}">-</button>
                            <input type="text" class="form-control text-center" value="${item.cantidad}" readonly>
                            <button type="button" class="btn btn-outline-secondary btn-sumar" data-index="${index}">+</button>
                        </div>
                    </td>
                    <td>${item.precio_unitario.toFixed(2)}
                        ${item.descuento_porcentaje > 0 ? `<small class="d-block text-success">-${item.descuento_porcentaje}%</small>` : ''}
                    </td>
                    <td class="text-end">${item.subtotal.toFixed(2)}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-danger btn-eliminar" data-index="${index}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                itemsCarrito.appendChild(fila);
            });
            
            // Actualizar total
            const total = calcularTotalCarrito();
            totalCarrito.textContent = `${total.toFixed(2)}`;
            totalVentaInput.value = total.toFixed(2);
            
            // Habilitar botón de registro
            btnRegistrarVenta.disabled = false;
            
            // Guardar carrito en JSON para enviar al servidor
            carritoJson.value = JSON.stringify(carrito);
            
            // Eventos para modificar cantidades
            document.querySelectorAll('.btn-restar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    if (carrito[index].cantidad > 1) {
                        carrito[index].cantidad--;
                        carrito[index].subtotal = (carrito[index].precio_unitario - carrito[index].descuento_aplicado) * carrito[index].cantidad;
                        actualizarCarrito();
                    }
                });
            });
            
            document.querySelectorAll('.btn-sumar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    carrito[index].cantidad++;
                    carrito[index].subtotal = (carrito[index].precio_unitario - carrito[index].descuento_aplicado) * carrito[index].cantidad;
                    actualizarCarrito();
                });
            });
            
            document.querySelectorAll('.btn-eliminar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    carrito.splice(index, 1);
                    actualizarCarrito();
                });
            });
        }
    }
    
    // Función: Calcular total del carrito
    function calcularTotalCarrito() {
        return carrito.reduce((total, item) => total + item.subtotal, 0);
    }
    
    // Función: Actualizar información de caja
    function actualizarEfectivoCaja() {
        fetch('/turnos/efectivo-caja/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('efectivo-caja').textContent = ' + data.efectivo_final.toFixed(2);
                }
            })
            .catch(error => console.error('Error al actualizar efectivo en caja:', error));
    }
    
    // Evento: Actualizar caja
    document.getElementById('btnActualizarCaja').addEventListener('click', actualizarEfectivoCaja);
    
    // Actualizar fecha y hora actual
    function actualizarFechaHora() {
        const ahora = new Date();
        const opciones = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        document.getElementById('fecha-hora-actual').textContent = ahora.toLocaleDateString('es-ES', opciones);
    }
    
    actualizarFechaHora();
    setInterval(actualizarFechaHora, 60000); // Actualizar cada minuto
    
    // Actualizar efectivo en caja periódicamente
    setInterval(actualizarEfectivoCaja, 30000); // Cada 30 segundos
});
</script>
{% endblock %}