{% extends 'base.html' %}

{% block title %}Registro de Venta | VIT PHARMA{% endblock %}

{% block content %}
<style>
    .venta-container {
        max-width: 95%;
        margin: auto;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.2);
    }

    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .header-title {
        font-size: 24px;
        font-weight: bold;
        color: #004AAD;
    }

    .turno-info {
        background-color: #e8f5e9;
        border-left: 5px solid #4caf50;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .search-container {
        display: flex;
        margin-bottom: 20px;
        gap: 10px;
    }

    .search-container input {
        flex: 1;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 16px;
    }

    .search-container button {
        padding: 10px 15px;
        background-color: #007BFF;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
    }

    .productos-resultados {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: none;
    }

    .producto-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: 0.3s;
    }

    .producto-item:hover {
        background-color: #f5f5f5;
    }

    .carrito-container {
        margin-top: 30px;
    }

    .carrito-title {
        font-size: 18px;
        font-weight: bold;
        color: #004AAD;
        margin-bottom: 10px;
    }

    .carrito-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    .carrito-table th, .carrito-table td {
        padding: 12px;
        text-align: center;
        border-bottom: 1px solid #ddd;
    }

    .carrito-table th {
        background-color: #004AAD;
        color: white;
        font-weight: bold;
    }

    .btn-eliminar {
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
    }

    .totales-container {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }

    .metodo-pago {
        flex: 1;
        margin-right: 20px;
    }

    .metodo-pago select {
        width: 100%;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
    }

    .totales {
        flex: 1;
        text-align: right;
    }

    .total-label {
        font-size: 18px;
        font-weight: bold;
    }

    .total-value {
        font-size: 24px;
        font-weight: bold;
        color: #004AAD;
    }

    .btn-procesar-venta {
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 15px 20px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        margin-top: 20px;
        transition: 0.3s;
    }

    .btn-procesar-venta:hover {
        background-color: #218838;
    }

    .btn-procesar-venta:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }

    .cantidad-input {
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ccc;
        width: 70px;
        text-align: center;
    }

    .mensaje-vacio {
        text-align: center;
        padding: 20px;
        color: #6c757d;
        font-style: italic;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        width: 50%;
        max-width: 500px;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .modal-title {
        font-size: 20px;
        font-weight: bold;
        color: #004AAD;
    }

    .close-button {
        font-size: 24px;
        cursor: pointer;
    }

    .ticket-link {
        display: inline-block;
        margin-top: 15px;
        background-color: #007BFF;
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
    }

    .turno-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .stat-card {
        flex: 1;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stat-title {
        font-size: 14px;
        color: #555;
        margin-bottom: 5px;
    }

    .stat-value {
        font-size: 18px;
        font-weight: bold;
        color: #004AAD;
    }

    .actions-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .action-button {
        padding: 10px 15px;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
        color: white;
    }

    .btn-historial {
        background-color: #17a2b8;
    }
</style>

<div class="venta-container">
    <div class="header-section">
        <h2 class="header-title">üßæ Registro de Venta</h2>
        <div class="actions-row">
            <a href="{% url 'ventas:historial_ventas' %}" class="action-button btn-historial">üìã Ver Historial</a>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} text-center fw-bold mb-3">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {% if turno_activo %}
        <!-- Informaci√≥n del turno activo -->
        <div class="turno-info">
            <strong>Turno activo:</strong> #{{ turno_activo.id }} | 
            <strong>Inicio:</strong> {{ turno_activo.hora_inicio }} | 
            <strong>Vendedor:</strong> {{ turno_activo.usuario.get_full_name|default:turno_activo.usuario.username }}
        </div>

        <!-- Estad√≠sticas del turno actual -->
        <div class="turno-stats">
            <div class="stat-card">
                <div class="stat-title">Ventas Realizadas</div>
                <div class="stat-value">{{ cantidad_ventas }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Total Vendido</div>
                <div class="stat-value">${{ total_ventas }}</div>
            </div>
        </div>

        <!-- Buscador de productos -->
        <div class="search-container">
            <input type="text" id="buscar-producto" placeholder="üîç Buscar producto por nombre o c√≥digo de barras...">
            <button id="btn-buscar">Buscar</button>
        </div>

        <!-- Resultados de b√∫squeda -->
        <div class="productos-resultados" id="resultados-productos">
            <!-- Aqu√≠ se cargar√°n los resultados de la b√∫squeda mediante JavaScript -->
        </div>

        <!-- Carrito de compras -->
        <div class="carrito-container">
            <h3 class="carrito-title">üìã Productos en esta venta</h3>

            <table class="carrito-table" id="carrito-table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Lote</th>
                        <th>Precio</th>
                        <th>Descuento</th>
                        <th>Cantidad</th>
                        <th>Subtotal</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="carrito-items">
                    <!-- Los items se agregar√°n aqu√≠ mediante JavaScript -->
                    <tr class="mensaje-vacio">
                        <td colspan="7">No hay productos agregados a la venta</td>
                    </tr>
                </tbody>
            </table>

            <!-- Totales y m√©todo de pago -->
            <div class="totales-container">
                <div class="metodo-pago">
                    <label for="metodo-pago-select"><strong>M√©todo de Pago:</strong></label>
                    <select id="metodo-pago-select">
                        <option value="">Seleccione un m√©todo de pago</option>
                        {% for metodo in metodos_pago %}
                            <option value="{{ metodo.id }}">{{ metodo.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="totales">
                    <span class="total-label">Total:</span>
                    <span class="total-value" id="total-venta">$0.00</span>
                </div>
            </div>

            <!-- Bot√≥n de procesar venta -->
            <button id="btn-procesar-venta" class="btn-procesar-venta" disabled>
                üõí Procesar Venta
            </button>
        </div>
    {% else %}
        <div class="alert alert-warning text-center">
            <h4>‚ö†Ô∏è No hay turno activo</h4>
            <p>Debes iniciar un turno antes de registrar ventas.</p>
            <a href="{% url 'turnos:turno_vendedor' %}" class="btn btn-primary mt-3">Ir a Gesti√≥n de Turnos</a>
        </div>
    {% endif %}
</div>

<!-- Modal de confirmaci√≥n de venta -->
<div id="modal-venta" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">‚úÖ Venta Procesada Correctamente</h3>
            <span class="close-button" id="cerrar-modal">&times;</span>
        </div>
        <p>La venta ha sido registrada exitosamente.</p>
        <p><strong>Total:</strong> <span id="modal-total">$0.00</span></p>
        <p><strong>Venta #:</strong> <span id="modal-venta-id"></span></p>
        <div class="d-flex justify-content-between mt-3">
            <a href="#" id="modal-ticket-link" class="ticket-link" target="_blank">üìÑ Ver Ticket</a>
            <a href="#" id="modal-nueva-venta" class="ticket-link">‚ûï Nueva Venta</a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables globales
        const carrito = [];
        let totalVenta = 0;
        
        // Referencias DOM
        const buscarInput = document.getElementById('buscar-producto');
        const buscarBtn = document.getElementById('btn-buscar');
        const resultadosDiv = document.getElementById('resultados-productos');
        const carritoItems = document.getElementById('carrito-items');
        const totalVentaSpan = document.getElementById('total-venta');
        const metodoPagoSelect = document.getElementById('metodo-pago-select');
        const procesarVentaBtn = document.getElementById('btn-procesar-venta');
        
        // Modal
        const modal = document.getElementById('modal-venta');
        const cerrarModal = document.getElementById('cerrar-modal');
        const modalTotal = document.getElementById('modal-total');
        const modalVentaId = document.getElementById('modal-venta-id');
        const modalTicketLink = document.getElementById('modal-ticket-link');
        const modalNuevaVenta = document.getElementById('modal-nueva-venta');
        
        // Funci√≥n para buscar productos
        function buscarProductos() {
            const query = buscarInput.value.trim();
            
            if (!query) {
                resultadosDiv.style.display = 'none';
                return;
            }
            
            // Mostrar indicador de carga
            resultadosDiv.innerHTML = '<div class="p-3 text-center">Buscando productos...</div>';
            resultadosDiv.style.display = 'block';
            
            // Realizar petici√≥n AJAX para buscar productos
            fetch(`{% url 'ventas:buscar_productos' %}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.productos && data.productos.length > 0) {
                        mostrarResultados(data.productos);
                    } else {
                        resultadosDiv.innerHTML = '<div class="producto-item">No se encontraron productos con stock disponible</div>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    resultadosDiv.innerHTML = '<div class="producto-item text-danger">Error al buscar productos</div>';
                });
        }
        
        // Funci√≥n para mostrar resultados de b√∫squeda
        function mostrarResultados(productos) {
            resultadosDiv.innerHTML = '';
            
            productos.forEach(producto => {
                const productoDiv = document.createElement('div');
                productoDiv.className = 'producto-item';
                productoDiv.innerHTML = `
                    <strong>${producto.nombre}</strong> - C√≥digo: ${producto.codigo}
                    <br>Categor√≠a: ${producto.categoria || 'No especificada'}
                    <br>Lotes disponibles: ${producto.lotes.length}
                `;
                
                productoDiv.addEventListener('click', () => mostrarSeleccionLote(producto));
                
                resultadosDiv.appendChild(productoDiv);
            });
        }
        
        // Funci√≥n para mostrar selecci√≥n de lote
        function mostrarSeleccionLote(producto) {
            resultadosDiv.innerHTML = '';
            
            const volverDiv = document.createElement('div');
            volverDiv.className = 'producto-item';
            volverDiv.innerHTML = '<strong>‚Üê Volver a resultados</strong>';
            volverDiv.addEventListener('click', buscarProductos);
            resultadosDiv.appendChild(volverDiv);
            
            producto.lotes.forEach(lote => {
                const loteDiv = document.createElement('div');
                loteDiv.className = 'producto-item';
                
                // Calcular precio con descuento
                const precioConDescuento = lote.precio - (lote.precio * lote.descuento / 100);
                
                loteDiv.innerHTML = `
                    <strong>${producto.nombre}</strong> - Lote: ${lote.lote}
                    <br>Precio: $${lote.precio.toFixed(2)}
                    ${lote.descuento > 0 ? `<br>Descuento: ${lote.descuento}% (Final: $${precioConDescuento.toFixed(2)})` : ''}
                    <br>Stock: ${lote.stock} unidades
                    <br>Caducidad: ${lote.caducidad}
                    <div style="margin-top: 10px;">
                        <label>Cantidad: 
                            <input type="number" min="1" max="${lote.stock}" value="1" class="cantidad-input">
                        </label>
                        <button style="margin-left: 10px; padding: 5px 10px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Agregar
                        </button>
                    </div>
                `;
                
                const agregarBtn = loteDiv.querySelector('button');
                const cantidadInput = loteDiv.querySelector('input');
                
                agregarBtn.addEventListener('click', () => {
                    const cantidad = parseInt(cantidadInput.value);
                    
                    if (cantidad > 0 && cantidad <= lote.stock) {
                        agregarAlCarrito(producto, lote, cantidad);
                        resultadosDiv.style.display = 'none';
                        buscarInput.value = '';
                    } else {
                        alert('Cantidad inv√°lida o mayor al stock disponible');
                    }
                });
                
                resultadosDiv.appendChild(loteDiv);
            });
        }
        
        // Funci√≥n para agregar producto al carrito
        function agregarAlCarrito(producto, lote, cantidad) {
            // Verificar si ya existe en el carrito
            const existente = carrito.findIndex(item => item.lote_id === lote.id);
            
            if (existente >= 0) {
                // Actualizar cantidad
                carrito[existente].cantidad += cantidad;
                actualizarCarritoUI();
                return;
            }
            
            // Calcular descuento y subtotal
            const descuentoUnitario = lote.precio * (lote.descuento / 100);
            const precioConDescuento = lote.precio - descuentoUnitario;
            const subtotal = precioConDescuento * cantidad;
            
            // Agregar al carrito
            carrito.push({
                producto_id: producto.id,
                producto_nombre: producto.nombre,
                lote_id: lote.id,
                lote_codigo: lote.lote,
                precio: lote.precio,
                descuento_porcentaje: lote.descuento,
                descuento_unitario: descuentoUnitario,
                cantidad: cantidad,
                subtotal: subtotal
            });
            
            actualizarCarritoUI();
        }
        
        // Funci√≥n para actualizar la UI del carrito
        function actualizarCarritoUI() {
            if (carrito.length === 0) {
                carritoItems.innerHTML = '<tr class="mensaje-vacio"><td colspan="7">No hay productos agregados a la venta</td></tr>';
                totalVenta = 0;
                totalVentaSpan.textContent = '$0.00';
                procesarVentaBtn.disabled = true;
                return;
            }
            
            carritoItems.innerHTML = '';
            totalVenta = 0;
            
            carrito.forEach((item, index) => {
                const fila = document.createElement('tr');
                
                fila.innerHTML = `
                    <td>${item.producto_nombre}</td>
                    <td>${item.lote_codigo}</td>
                    <td>$${item.precio.toFixed(2)}</td>
                    <td>${item.descuento_porcentaje > 0 ? `${item.descuento_porcentaje}% ($${item.descuento_unitario.toFixed(2)})` : 'N/A'}</td>
                    <td>
                        <input type="number" min="1" value="${item.cantidad}" class="cantidad-input" data-index="${index}">
                    </td>
                    <td>$${item.subtotal.toFixed(2)}</td>
                    <td>
                        <button class="btn-eliminar" data-index="${index}">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                
                carritoItems.appendChild(fila);
                totalVenta += item.subtotal;
            });
            
            // Actualizar total
            totalVentaSpan.textContent = `$${totalVenta.toFixed(2)}`;
            
            // Actualizar listeners para cantidad y eliminar
            document.querySelectorAll('.cantidad-input[data-index]').forEach(input => {
                input.addEventListener('change', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    const cantidad = parseInt(this.value);
                    
                    if (cantidad > 0) {
                        carrito[index].cantidad = cantidad;
                        // Recalcular subtotal
                        const precioConDescuento = carrito[index].precio - carrito[index].descuento_unitario;
                        carrito[index].subtotal = precioConDescuento * cantidad;
                        actualizarCarritoUI();
                    } else {
                        this.value = carrito[index].cantidad;
                    }
                });
            });
            
            document.querySelectorAll('.btn-eliminar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    carrito.splice(index, 1);
                    actualizarCarritoUI();
                });
            });
            
            // Habilitar/deshabilitar bot√≥n de procesar venta
            verificarProcesarVenta();
        }
        
        // Verificar si se puede procesar la venta
        function verificarProcesarVenta() {
            procesarVentaBtn.disabled = carrito.length === 0 || !metodoPagoSelect.value;
        }
        
        // Funci√≥n para procesar la venta
        function procesarVenta() {
            if (carrito.length === 0 || !metodoPagoSelect.value) {
                return;
            }
            
            // Deshabilitar bot√≥n mientras se procesa
            procesarVentaBtn.disabled = true;
            procesarVentaBtn.textContent = "Procesando...";
            
            // Crear FormData para enviar
            const formData = new FormData();
            formData.append('metodo_pago', metodoPagoSelect.value);
            formData.append('items', JSON.stringify(carrito));
            
            // Enviar petici√≥n para procesar venta
            fetch('{% url "ventas:procesar_venta" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar modal de √©xito
                    modalTotal.textContent = `$${totalVenta.toFixed(2)}`;
                    modalVentaId.textContent = data.venta_id;
                    
                    if (data.ticket_url) {
                        modalTicketLink.href = data.ticket_url;
                        modalTicketLink.style.display = 'inline-block';
                    } else {
                        modalTicketLink.style.display = 'none';
                    }
                    
                    modal.style.display = 'flex';
                    
                    // Limpiar carrito
                    carrito.length = 0;
                    actualizarCarritoUI();
                    
                    // Restaurar bot√≥n
                    procesarVentaBtn.disabled = true;
                    procesarVentaBtn.textContent = "üõí Procesar Venta";
                    
                    // Recargar las estad√≠sticas de la p√°gina sin recargar toda la p√°gina
                    // En producci√≥n, esta parte se har√≠a mejor con fetch y actualizaci√≥n de DOM
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                } else {
                    alert('Error: ' + (data.error || 'No se pudo procesar la venta'));
                    // Restaurar bot√≥n
                    procesarVentaBtn.disabled = false;
                    procesarVentaBtn.textContent = "üõí Procesar Venta";
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al procesar la venta');
                // Restaurar bot√≥n
                procesarVentaBtn.disabled = false;
                procesarVentaBtn.textContent = "üõí Procesar Venta";
            });
        }
        
        // Funci√≥n para obtener cookie (para CSRF)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Event Listeners
        if (buscarBtn) {
            buscarBtn.addEventListener('click', buscarProductos);
        }
        
        if (buscarInput) {
            buscarInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    buscarProductos();
                }
            });
        }
        
        if (metodoPagoSelect) {
            metodoPagoSelect.addEventListener('change', verificarProcesarVenta);
        }
        
        if (procesarVentaBtn) {
            procesarVentaBtn.addEventListener('click', procesarVenta);
        }
        
        // Modal event listeners
        if (cerrarModal) {
            cerrarModal.addEventListener('click', () => {
                modal.style.display = 'none';
            });
        }
        
        if (modalNuevaVenta) {
            modalNuevaVenta.addEventListener('click', (e) => {
                e.preventDefault();
                modal.style.display = 'none';
                buscarInput.focus();
            });
        }
        
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}