{% extends 'base.html' %}

{% block title %}Registrar Venta | VIT PHARMA{% endblock %}

{% block content %}
<style>
    /* Estilos personalizados */
    .main-header {
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 15px;
    }
    .search-input {
        border-left: 3px solid #004AAD;
        box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }
    .card-container {
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.09);
        border: none;
    }
    .form-label {
        font-weight: 600;
        color: #444;
    }
    .table-header {
        background-color:rgb(247, 231, 9);
    }
    .custom-button {
        padding: 8px 18px;
        border-radius: 6px;
        font-weight: 500;
    }
    .product-list-item:hover {
        background-color: #f8f9ff;
        border-left: 3px solid #004AAD;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4 main-header">
    <h2 class="mb-0 text-primary"><i class="fas fa-cash-register me-2"></i>Registrar Venta</h2>
    <a href="{% url 'authapp:vendedor_dashboard' %}" class="btn btn-outline-secondary custom-button">
        <i class="fas fa-arrow-left"></i> Regresar
    </a>
</div>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
            <i class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'warning' %}fa-exclamation-triangle{% elif message.tags == 'danger' %}fa-times-circle{% else %}fa-info-circle{% endif %} me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
    {% endfor %}
{% endif %}

<div class="card card-container mb-4">
    <div class="card-header bg-light py-3">
        <h5 class="mb-0 text-primary"><i class="fas fa-shopping-cart me-2"></i>Formulario de venta</h5>
    </div>
    <div class="card-body">
        <form method="post" action="{% url 'ventas:procesar_venta' %}" onsubmit="return enviarVenta()">
            {% csrf_token %}
            <div class="row mb-4 bg-light py-3 rounded">
                <div class="col-md-6">
                    <label for="{{ venta_form.metodo_pago.id_for_label }}" class="form-label">
                        <i class="fas fa-credit-card me-1 text-primary"></i> M√©todo de pago:
                    </label>
                    <div class="input-group">
                        {{ venta_form.metodo_pago }}
                    </div>
                    {% if venta_form.metodo_pago.errors %}
                        <div class="text-danger small mt-1">{{ venta_form.metodo_pago.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6" id="campo-efectivo" style="display:none;">
                    <label for="{{ venta_form.con_cuanto_paga.id_for_label }}" class="form-label">
                        <i class="fas fa-money-bill-wave me-1 text-success"></i> Con cu√°nto paga:
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        {{ venta_form.con_cuanto_paga }}
                    </div>
                    {% if venta_form.con_cuanto_paga.errors %}
                        <div class="text-danger small mt-1">{{ venta_form.con_cuanto_paga.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="mb-3">
                <label for="buscador-producto" class="form-label">
                    <i class="fas fa-search me-1 text-primary"></i> Buscar producto:
                </label>
                <input type="text" class="form-control search-input" placeholder="üîç Buscar producto por nombre o c√≥digo" id="buscador-producto" oninput="buscarProducto(this.value)">
            </div>

            <div id="lista-productos" class="mb-3"></div>
            <div id="lotes-producto" class="mb-4"></div>

            <input type="hidden" name="carrito_json" id="carrito_json">

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-shopping-basket me-2"></i>Carrito de compra</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-header text-white">
                                <tr>
                                    <th>Producto</th>
                                    <th>Lote</th>
                                    <th>Cantidad</th>
                                    <th>Precio</th>
                                    <th>Subtotal</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="carrito-body">
                                <tr><td colspan="6" class="text-center text-muted py-3">No hay productos en el carrito</td></tr>
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="4" class="text-end fw-bold">TOTAL:</td>
                                    <td id="total-carrito" class="fw-bold text-primary fs-5">$0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-danger custom-button" 
                        onclick="if(confirm('¬øEst√° seguro de cancelar la venta actual?')) {carrito = []; renderizarCarrito();}">
                    <i class="fas fa-ban me-1"></i> Cancelar
                </button>
                <button type="submit" class="btn btn-success custom-button px-4 shadow-sm">
                    <i class="fas fa-check-circle me-1"></i> Confirmar Venta
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let carrito = [];
let productosData = [];

function buscarProducto(query) {
    const listaProductos = document.getElementById("lista-productos");
    const lotesDiv = document.getElementById("lotes-producto");
    listaProductos.innerHTML = "";
    lotesDiv.innerHTML = "";

    if (query.trim().length < 2) return;

    fetch(`/ventas/api/buscar/?q=${query}`)
        .then(res => res.json())
        .then(data => {
            productosData = data.productos;
            if (productosData.length === 0) {
                listaProductos.innerHTML = `<div class="text-danger text-center">‚ö† No se encontraron productos.</div>`;
                return;
            }

            let html = '<div class="list-group shadow-sm">';
            productosData.forEach(p => {
                html += `<button type="button" class="list-group-item list-group-item-action product-list-item" onclick="mostrarLotes(${p.producto_id}, '${p.nombre}', '${p.codigo_barras}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-pills text-primary me-2"></i>${p.nombre}</span>
                        <span class="badge bg-secondary rounded-pill">${p.codigo_barras}</span>
                    </div>
                </button>`;
            });
            html += '</div>';
            listaProductos.innerHTML = html;
        })
        .catch(err => console.error("Error:", err));
}

function mostrarLotes(producto_id, nombre, codigo_barras) {
    const lotesDiv = document.getElementById("lotes-producto");
    lotesDiv.innerHTML = "";

    fetch(`/ventas/api/lotes/${producto_id}/`)
        .then(res => res.json())
        .then(p => {
            let html = `<div class="card shadow-sm mt-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0 d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-box me-2"></i>${nombre}</span>
                        <span class="badge bg-light text-dark">${codigo_barras}</span>
                    </h5>
                </div>
                <div class="card-body">`;
            
            if (p.lotes.length > 0) {
                html += `<div class="table-responsive"><table class="table table-striped table-bordered mt-2">
                    <thead class="table-light"><tr><th>Lote</th><th>Stock</th><th>Caducidad</th><th>Precio Final</th><th>Cantidad</th><th>Agregar</th></tr></thead><tbody>`;
                p.lotes.forEach(l => {
                    const inputId = `cant_${p.producto_id}_${l.lote_id}`;
                    html += `<tr>
                        <td>${l.lote}</td>
                        <td>${l.stock}</td>
                        <td>${l.caducidad}</td>
                        <td>$${l.precio_final}</td>
                        <td><input type="number" id="${inputId}" value="0" min="0" max="${l.stock}" class="form-control form-control-sm"></td>
                        <td><button type="button" class="btn btn-primary btn-sm"
                            onclick="agregarAlCarrito(${p.producto_id}, '${p.nombre}', ${l.lote_id}, '${l.lote}', ${l.precio}, ${l.descuento}, ${l.stock}, parseInt(document.getElementById('${inputId}').value))">
                            <i class="fas fa-cart-plus me-1"></i> Agregar</button></td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            } else {
                html += `<p class="text-danger mt-2">No hay lotes disponibles.</p>`;
            }
            html += `</div></div>`;
            lotesDiv.innerHTML = html;
        })
        .catch(err => console.error("Error al cargar lotes:", err));
}

function agregarAlCarrito(producto_id, nombre, lote_id, lote, precio, descuento, stock, cantidad) {
    if (cantidad <= 0 || cantidad > stock) {
        alert("‚ö† Cantidad inv√°lida.");
        return;
    }

    if (carrito.find(p => p.lote_id === lote_id)) {
        alert("‚ö† Este lote ya fue agregado.");
        return;
    }

    const precio_unitario = parseFloat(precio);
    const precio_final = precio_unitario - (precio_unitario * (parseFloat(descuento || 0) / 100));
    const subtotal = precio_final * cantidad;

    carrito.push({
        producto_id,
        lote_id,
        nombre,
        lote,
        cantidad,
        precio_unitario: precio_final.toFixed(2),
        descuento_aplicado: (precio_unitario - precio_final).toFixed(2),
        subtotal: subtotal.toFixed(2),
        stock: stock
    });

    renderizarCarrito();
}

function eliminarDelCarrito(index) {
    const eliminado = carrito[index];
    carrito.splice(index, 1);
    renderizarCarrito();

    const inputId = `cant_${eliminado.producto_id}_${eliminado.lote_id}`;
    const input = document.getElementById(inputId);
    if (input) {
        const maxActual = parseInt(input.getAttribute("max")) || 0;
        input.setAttribute("max", maxActual + eliminado.cantidad);
        input.value = 0;
    }
}

function actualizarCantidad(index, nuevaCantidad) {
    if (nuevaCantidad <= 0 || nuevaCantidad > carrito[index].stock) {
        alert("‚ö† Cantidad inv√°lida.");
        renderizarCarrito();
        return;
    }
    carrito[index].cantidad = nuevaCantidad;
    carrito[index].subtotal = (parseFloat(carrito[index].precio_unitario) * nuevaCantidad).toFixed(2);
    renderizarCarrito();
}

function renderizarCarrito() {
    const tbody = document.getElementById("carrito-body");
    tbody.innerHTML = "";

    if (carrito.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No hay productos en el carrito</td></tr>`;
        document.getElementById("total-carrito").innerText = "$0.00";
        return;
    }

    let total = 0;
    carrito.forEach((item, index) => {
        total += parseFloat(item.subtotal);
        tbody.innerHTML += `
            <tr>
                <td class="fw-bold text-primary">${item.nombre}</td>
                <td><span class="badge bg-light text-dark border">${item.lote}</span></td>
                <td>
                    <input type="number" class="form-control form-control-sm" value="${item.cantidad}" min="1" max="${item.stock}"
                    onchange="actualizarCantidad(${index}, parseInt(this.value))">
                </td>
                <td class="text-nowrap">$${item.precio_unitario}</td>
                <td class="text-nowrap fw-bold">$${item.subtotal}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="eliminarDelCarrito(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
    });

    document.getElementById("total-carrito").innerText = "$" + total.toFixed(2);
}

function enviarVenta() {
    if (carrito.length === 0) {
        alert("‚ö† Debes agregar al menos un producto al carrito.");
        return false;
    }

    const metodoPago = document.getElementById("id_metodo_pago");
    const campoPago = document.getElementById("id_con_cuanto_paga");

    if (metodoPago && campoPago) {
        const metodo = metodoPago.options[metodoPago.selectedIndex]?.text?.toLowerCase();
        if (metodo.includes("efectivo")) {
            const totalVenta = carrito.reduce((sum, item) => sum + parseFloat(item.subtotal), 0);
            const montoPagado = parseFloat(campoPago.value || "0");
            if (montoPagado < totalVenta) {
                alert(`‚ö† El monto pagado ($${montoPagado.toFixed(2)}) no cubre el total ($${totalVenta.toFixed(2)}).`);
                return false;
            }
        }
    }

    document.getElementById("carrito_json").value = JSON.stringify(carrito);
    return true;
}

document.addEventListener("DOMContentLoaded", () => {
    const metodoPago = document.getElementById("id_metodo_pago");
    const campoEfectivo = document.getElementById("campo-efectivo");

    function toggleCampoEfectivo() {
        const selectedText = metodoPago.options[metodoPago.selectedIndex]?.text?.toLowerCase() || '';
        campoEfectivo.style.display = selectedText.includes("efectivo") ? "block" : "none";
    }

    if (metodoPago) {
        toggleCampoEfectivo();
        metodoPago.addEventListener("change", toggleCampoEfectivo);
        
        // Agregar clases Bootstrap al select
        metodoPago.classList.add('form-select');
    }
    
    // Agregar clases al campo de pago
    const campoPago = document.getElementById("id_con_cuanto_paga");
    if (campoPago) {
        campoPago.classList.add('form-control');
    }
});
</script>
{% endblock %}