{% extends 'base.html' %}

{% block title %}Registrar Venta | VIT PHARMA{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0"><i class="fas fa-cash-register me-2"></i>Registrar Venta</h2>
    <a href="{% url 'authapp:vendedor_dashboard' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Regresar
    </a>
</div>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
    {% endfor %}
{% endif %}

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="post" action="{% url 'ventas:procesar_venta' %}" onsubmit="return enviarVenta()">
            {% csrf_token %}
            <div class="row mb-4">
                <div class="col-md-6">
                    <label for="{{ venta_form.metodo_pago.id_for_label }}" class="form-label">M√©todo de pago:</label>
                    {{ venta_form.metodo_pago }}
                    {% if venta_form.metodo_pago.errors %}
                        <div class="text-danger small">{{ venta_form.metodo_pago.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6" id="campo-efectivo" style="display:none;">
                    <label for="{{ venta_form.con_cuanto_paga.id_for_label }}" class="form-label">Con cu√°nto paga (solo efectivo):</label>
                    {{ venta_form.con_cuanto_paga }}
                    {% if venta_form.con_cuanto_paga.errors %}
                        <div class="text-danger small">{{ venta_form.con_cuanto_paga.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="mb-3">
                <input type="text" class="form-control" placeholder="üîç Buscar producto por nombre o c√≥digo" id="buscador-producto" oninput="buscarProducto(this.value)">
            </div>

            <div id="lista-productos" class="mb-3"></div>
            <div id="lotes-producto" class="mb-4"></div>

            <input type="hidden" name="carrito_json" id="carrito_json">

            <div class="table-responsive mb-4">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Producto</th>
                            <th>Lote</th>
                            <th>Cantidad</th>
                            <th>Precio</th>
                            <th>Subtotal</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="carrito-body">
                        <tr><td colspan="6" class="text-center text-muted">No hay productos en el carrito</td></tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-end fw-bold">TOTAL:</td>
                            <td id="total-carrito" class="fw-bold">$0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-check-circle"></i> Confirmar Venta
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let carrito = [];
let productosData = [];

function buscarProducto(query) {
    const listaProductos = document.getElementById("lista-productos");
    const lotesDiv = document.getElementById("lotes-producto");
    listaProductos.innerHTML = "";
    lotesDiv.innerHTML = "";

    if (query.trim().length < 2) return;

    fetch(`/ventas/api/buscar/?q=${query}`)
        .then(res => res.json())
        .then(data => {
            productosData = data.productos;
            if (productosData.length === 0) {
                listaProductos.innerHTML = `<div class="text-danger text-center">‚ö† No se encontraron productos.</div>`;
                return;
            }

            let html = '<div class="list-group">';
            productosData.forEach(p => {
                html += `<button type="button" class="list-group-item list-group-item-action" onclick="mostrarLotes(${p.producto_id}, '${p.nombre}', '${p.codigo_barras}')">${p.nombre} <small class="text-muted">(${p.codigo_barras})</small></button>`;
            });
            html += '</div>';
            listaProductos.innerHTML = html;
        })
        .catch(err => console.error("Error:", err));
}

function mostrarLotes(producto_id, nombre, codigo_barras) {
    const lotesDiv = document.getElementById("lotes-producto");
    lotesDiv.innerHTML = "";

    fetch(`/ventas/api/lotes/${producto_id}/`)
        .then(res => res.json())
        .then(p => {
            let html = `<h5 class="mt-3">${nombre} <span class="text-muted">(${codigo_barras})</span></h5>`;
            if (p.lotes.length > 0) {
                html += `<div class="table-responsive"><table class="table table-sm table-bordered mt-2">
                    <thead class="table-light"><tr><th>Lote</th><th>Stock</th><th>Caducidad</th><th>Precio Final</th><th>Cantidad</th><th>Agregar</th></tr></thead><tbody>`;
                p.lotes.forEach(l => {
                    const inputId = `cant_${p.producto_id}_${l.lote_id}`;
                    html += `<tr>
                        <td>${l.lote}</td>
                        <td>${l.stock}</td>
                        <td>${l.caducidad}</td>
                        <td>$${l.precio_final}</td>
                        <td><input type="number" id="${inputId}" value="0" min="0" max="${l.stock}" class="form-control form-control-sm"></td>
                        <td><button type="button" class="btn btn-primary btn-sm"
                            onclick="agregarAlCarrito(${p.producto_id}, '${p.nombre}', ${l.lote_id}, '${l.lote}', ${l.precio}, ${l.descuento}, ${l.stock}, parseInt(document.getElementById('${inputId}').value))">
                            Agregar</button></td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            } else {
                html += `<p class="text-danger mt-2">No hay lotes disponibles.</p>`;
            }
            lotesDiv.innerHTML = html;
        })
        .catch(err => console.error("Error al cargar lotes:", err));
}

function agregarAlCarrito(producto_id, nombre, lote_id, lote, precio, descuento, stock, cantidad) {
    if (cantidad <= 0 || cantidad > stock) {
        alert("‚ö† Cantidad inv√°lida.");
        return;
    }

    if (carrito.find(p => p.lote_id === lote_id)) {
        alert("‚ö† Este lote ya fue agregado.");
        return;
    }

    const precio_unitario = parseFloat(precio);
    const precio_final = precio_unitario - (precio_unitario * (parseFloat(descuento || 0) / 100));
    const subtotal = precio_final * cantidad;

    carrito.push({
        producto_id,
        lote_id,
        nombre,
        lote,
        cantidad,
        precio_unitario: precio_final.toFixed(2),
        descuento_aplicado: (precio_unitario - precio_final).toFixed(2),
        subtotal: subtotal.toFixed(2),
        stock: stock
    });

    renderizarCarrito();
}

function eliminarDelCarrito(index) {
    const eliminado = carrito[index];
    carrito.splice(index, 1);
    renderizarCarrito();

    const inputId = `cant_${eliminado.producto_id}_${eliminado.lote_id}`;
    const input = document.getElementById(inputId);
    if (input) {
        const maxActual = parseInt(input.getAttribute("max")) || 0;
        input.setAttribute("max", maxActual + eliminado.cantidad);
        input.value = 0;
    }
}

function actualizarCantidad(index, nuevaCantidad) {
    if (nuevaCantidad <= 0 || nuevaCantidad > carrito[index].stock) {
        alert("‚ö† Cantidad inv√°lida.");
        renderizarCarrito();
        return;
    }
    carrito[index].cantidad = nuevaCantidad;
    carrito[index].subtotal = (parseFloat(carrito[index].precio_unitario) * nuevaCantidad).toFixed(2);
    renderizarCarrito();
}

function renderizarCarrito() {
    const tbody = document.getElementById("carrito-body");
    tbody.innerHTML = "";

    if (carrito.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No hay productos en el carrito</td></tr>`;
        document.getElementById("total-carrito").innerText = "$0.00";
        return;
    }

    let total = 0;
    carrito.forEach((item, index) => {
        total += parseFloat(item.subtotal);
        tbody.innerHTML += `
            <tr>
                <td>${item.nombre}</td>
                <td>${item.lote}</td>
                <td>
                    <input type="number" class="form-control form-control-sm" value="${item.cantidad}" min="1" max="${item.stock}"
                    onchange="actualizarCantidad(${index}, parseInt(this.value))">
                </td>
                <td>$${item.precio_unitario}</td>
                <td>$${item.subtotal}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="eliminarDelCarrito(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
    });

    document.getElementById("total-carrito").innerText = "$" + total.toFixed(2);
}

function enviarVenta() {
    if (carrito.length === 0) {
        alert("‚ö† Debes agregar al menos un producto al carrito.");
        return false;
    }

    const metodoPago = document.getElementById("id_metodo_pago");
    const campoPago = document.getElementById("id_con_cuanto_paga");

    if (metodoPago && campoPago) {
        const metodo = metodoPago.options[metodoPago.selectedIndex]?.text?.toLowerCase();
        if (metodo.includes("efectivo")) {
            const totalVenta = carrito.reduce((sum, item) => sum + parseFloat(item.subtotal), 0);
            const montoPagado = parseFloat(campoPago.value || "0");
            if (montoPagado < totalVenta) {
                alert(`‚ö† El monto pagado ($${montoPagado.toFixed(2)}) no cubre el total ($${totalVenta.toFixed(2)}).`);
                return false;
            }
        }
    }

    document.getElementById("carrito_json").value = JSON.stringify(carrito);
    return true;
}

document.addEventListener("DOMContentLoaded", () => {
    const metodoPago = document.getElementById("id_metodo_pago");
    const campoEfectivo = document.getElementById("campo-efectivo");

    function toggleCampoEfectivo() {
        const selectedText = metodoPago.options[metodoPago.selectedIndex]?.text?.toLowerCase() || '';
        campoEfectivo.style.display = selectedText.includes("efectivo") ? "block" : "none";
    }

    if (metodoPago) {
        toggleCampoEfectivo();
        metodoPago.addEventListener("change", toggleCampoEfectivo);
    }
});
</script>
{% endblock %}
